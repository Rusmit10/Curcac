name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker
      run: |
        sudo apt-get update
        sudo apt-get install -y docker.io docker-compose
        
    - name: Build Services
      run: |
        docker-compose build
        
    - name: Start Services
      run: |
        docker-compose up -d
        
    - name: Wait for Services
      run: |
        sleep 30
        docker ps
        
    - name: Run Tests
      run: |
        if [ -f "tests/test_api.sh" ]; then
          chmod +x tests/test_api.sh
          ./tests/test_api.sh || exit 1
        else
          echo "⚠️ No test script found, skipping tests"
        fi
        
    - name: Stop Services
      if: always()
      run: |
        docker-compose down || true
